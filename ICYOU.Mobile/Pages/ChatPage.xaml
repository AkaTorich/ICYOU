<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:ICYOU.Mobile.ViewModels"
             x:Class="ICYOU.Mobile.Pages.ChatPage"
             x:Name="ThisPage">

    <Grid RowDefinitions="*,Auto,Auto,Auto">

        <!-- Messages List -->
        <CollectionView x:Name="MessagesList"
                        Grid.Row="0"
                        ItemsUpdatingScrollMode="KeepLastItemInView">
            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="vm:MessageViewModel">
                    <Grid Padding="10,5">
                        <Frame BackgroundColor="{Binding BackgroundColor}"
                               HorizontalOptions="{Binding Alignment}"
                               Padding="10"
                               CornerRadius="10"
                               HasShadow="False"
                               MaximumWidthRequest="300">
                            <Frame.GestureRecognizers>
                                <TapGestureRecognizer NumberOfTapsRequired="2" Tapped="OnMessageDoubleTapped" CommandParameter="{Binding .}" />
                            </Frame.GestureRecognizers>
                            <VerticalStackLayout>
                                <!-- Sender Name (if not own message) -->
                                <Label Text="{Binding SenderName}"
                                       FontSize="12"
                                       FontAttributes="Bold"
                                       TextColor="#4CAF50"
                                       IsVisible="{Binding IsOwnMessage, Converter={StaticResource InvertedBoolConverter}}"
                                       Margin="0,0,0,5" />

                                <!-- Quote Block (if message has quote) -->
                                <Frame IsVisible="{Binding HasQuote}"
                                       BackgroundColor="#F0F0F0"
                                       Padding="8"
                                       CornerRadius="6"
                                       HasShadow="False"
                                       Margin="0,0,0,6">
                                    <Grid ColumnDefinitions="3,8,*">
                                        <!-- Vertical Line -->
                                        <BoxView Grid.Column="0"
                                                 BackgroundColor="#4CAF50"
                                                 CornerRadius="2" />

                                        <!-- Quote Content -->
                                        <VerticalStackLayout Grid.Column="2">
                                            <Label Text="{Binding QuoteSender}"
                                                   FontSize="11"
                                                   FontAttributes="Bold"
                                                   TextColor="#4CAF50" />
                                            <!-- Quote Content with Emotes -->
                                            <FlexLayout BindableLayout.ItemsSource="{Binding QuoteContentParts}"
                                                        Wrap="Wrap"
                                                        AlignItems="Center">
                                                <BindableLayout.ItemTemplate>
                                                    <DataTemplate x:DataType="vm:ContentPart">
                                                        <Grid>
                                                            <!-- Text Part -->
                                                            <Label Text="{Binding Text}"
                                                                   FontSize="12"
                                                                   TextColor="#666666"
                                                                   LineBreakMode="WordWrap"
                                                                   IsVisible="{Binding IsEmote, Converter={StaticResource InvertedBoolConverter}}" />
                                                            <!-- Emote Part -->
                                                            <Image Source="{Binding EmoteImage}"
                                                                   WidthRequest="20"
                                                                   HeightRequest="20"
                                                                   Aspect="AspectFit"
                                                                   VerticalOptions="Center"
                                                                   Margin="1,0"
                                                                   IsVisible="{Binding IsEmote}"
                                                                   IsAnimationPlaying="True" />
                                                        </Grid>
                                                    </DataTemplate>
                                                </BindableLayout.ItemTemplate>
                                            </FlexLayout>
                                        </VerticalStackLayout>
                                    </Grid>
                                </Frame>

                                <!-- LinkPreview (ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ) -->
                                <VerticalStackLayout IsVisible="{Binding HasLinkPreview}" Spacing="6">
                                    <!-- Ð¢ÐµÐºÑÑ‚ Ð¿ÐµÑ€ÐµÐ´ Ð¿Ñ€ÐµÐ²ÑŒÑŽ (Ð¾Ð±Ñ‹Ñ‡Ð½Ð¾ ÑÑÑ‹Ð»ÐºÐ°) -->
                                    <Label Text="{Binding TextBeforePreview}"
                                           FontSize="14"
                                           LineBreakMode="WordWrap"
                                           IsVisible="{Binding HasTextBeforePreview}" />

                                    <!-- ÐŸÑ€ÐµÐ²ÑŒÑŽ ÐºÐ°Ñ€Ñ‚Ð¾Ñ‡ÐºÐ° -->
                                    <Frame BackgroundColor="#F5F5F5"
                                           Padding="0"
                                           CornerRadius="8"
                                           HasShadow="False"
                                           MaximumWidthRequest="280">
                                        <Frame.GestureRecognizers>
                                            <TapGestureRecognizer Tapped="OnLinkPreviewTapped" CommandParameter="{Binding .}" />
                                        </Frame.GestureRecognizers>
                                        <VerticalStackLayout Spacing="0">
                                            <!-- ÐšÐ°Ñ€Ñ‚Ð¸Ð½ÐºÐ° (ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ) -->
                                            <Image Source="{Binding LinkPreviewImageUrl}"
                                                   Aspect="AspectFill"
                                                   HeightRequest="140"
                                                   IsVisible="{Binding HasLinkPreviewImage}" />

                                            <!-- ÐšÐ¾Ð½Ñ‚ÐµÐ½Ñ‚ -->
                                            <Grid Padding="10" ColumnDefinitions="3,8,*">
                                                <!-- Ð’ÐµÑ€Ñ‚Ð¸ÐºÐ°Ð»ÑŒÐ½Ð°Ñ Ð»Ð¸Ð½Ð¸Ñ -->
                                                <BoxView Grid.Column="0"
                                                         BackgroundColor="#4CAF50"
                                                         CornerRadius="2" />

                                                <!-- Ð¢ÐµÐºÑÑ‚ -->
                                                <VerticalStackLayout Grid.Column="2" Spacing="2">
                                                    <Label Text="{Binding LinkPreviewSiteName}"
                                                           FontSize="11"
                                                           TextColor="#4CAF50"
                                                           FontAttributes="Bold" />
                                                    <Label Text="{Binding LinkPreviewTitle}"
                                                           FontSize="13"
                                                           FontAttributes="Bold"
                                                           LineBreakMode="WordWrap"
                                                           MaxLines="2" />
                                                    <Label Text="{Binding LinkPreviewDescription}"
                                                           FontSize="12"
                                                           TextColor="#666666"
                                                           LineBreakMode="WordWrap"
                                                           MaxLines="3"
                                                           IsVisible="{Binding HasLinkPreviewDescription}" />
                                                </VerticalStackLayout>
                                            </Grid>
                                        </VerticalStackLayout>
                                    </Frame>
                                </VerticalStackLayout>

                                <!-- Message Content -->
                                <!-- Ð•ÑÐ»Ð¸ ÐµÑÑ‚ÑŒ Ñ†Ð¸Ñ‚Ð°Ñ‚Ð° - Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ReplyText with Emotes -->
                                <FlexLayout IsVisible="{Binding HasQuote}"
                                            BindableLayout.ItemsSource="{Binding ReplyTextParts}"
                                            Wrap="Wrap"
                                            AlignItems="Center">
                                    <BindableLayout.ItemTemplate>
                                        <DataTemplate x:DataType="vm:ContentPart">
                                            <Grid>
                                                <!-- Text Part -->
                                                <Label Text="{Binding Text}"
                                                       FontSize="14"
                                                       LineBreakMode="WordWrap"
                                                       IsVisible="{Binding IsEmote, Converter={StaticResource InvertedBoolConverter}}" />
                                                <!-- Emote Part -->
                                                <Image Source="{Binding EmoteImage}"
                                                       WidthRequest="24"
                                                       HeightRequest="24"
                                                       Aspect="AspectFit"
                                                       VerticalOptions="Center"
                                                       Margin="2,0"
                                                       IsVisible="{Binding IsEmote}"
                                                       IsAnimationPlaying="True" />
                                            </Grid>
                                        </DataTemplate>
                                    </BindableLayout.ItemTemplate>
                                </FlexLayout>

                                <!-- Ð•ÑÐ»Ð¸ Ð² Ñ†Ð¸Ñ‚Ð°Ñ‚Ðµ ÐµÑÑ‚ÑŒ Ð¿Ñ€ÐµÐ²ÑŒÑŽ ÑÑÑ‹Ð»ÐºÐ¸ - Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ title Ð¸ description -->
                                <VerticalStackLayout IsVisible="{Binding HasQuoteLinkPreview}" Margin="0,6,0,0">
                                    <Label FontSize="12"
                                           FontAttributes="Bold"
                                           LineBreakMode="WordWrap">
                                        <Label.FormattedText>
                                            <FormattedString>
                                                <Span Text="ðŸ”— " />
                                                <Span Text="{Binding QuoteLinkPreviewTitle}" />
                                            </FormattedString>
                                        </Label.FormattedText>
                                    </Label>
                                    <Label Text="{Binding QuoteLinkPreviewDescription}"
                                           FontSize="11"
                                           TextColor="#666666"
                                           LineBreakMode="WordWrap"
                                           Margin="0,2,0,0" />
                                </VerticalStackLayout>

                                <!-- Ð•ÑÐ»Ð¸ Ð½ÐµÑ‚ Ñ†Ð¸Ñ‚Ð°Ñ‚Ñ‹ Ð¸ Ð½ÐµÑ‚ Ð¿Ñ€ÐµÐ²ÑŒÑŽ - Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð¿Ð¾Ð»Ð½Ñ‹Ð¹ Content with Emotes -->
                                <FlexLayout IsVisible="{Binding ShowFullContent}"
                                            BindableLayout.ItemsSource="{Binding ContentParts}"
                                            Wrap="Wrap"
                                            AlignItems="Center">
                                    <BindableLayout.ItemTemplate>
                                        <DataTemplate x:DataType="vm:ContentPart">
                                            <Grid>
                                                <!-- Text Part -->
                                                <Label Text="{Binding Text}"
                                                       FontSize="14"
                                                       LineBreakMode="WordWrap"
                                                       IsVisible="{Binding IsEmote, Converter={StaticResource InvertedBoolConverter}}" />
                                                <!-- Emote Part -->
                                                <Image Source="{Binding EmoteImage}"
                                                       WidthRequest="24"
                                                       HeightRequest="24"
                                                       Aspect="AspectFit"
                                                       VerticalOptions="Center"
                                                       Margin="2,0"
                                                       IsVisible="{Binding IsEmote}"
                                                       IsAnimationPlaying="True" />
                                            </Grid>
                                        </DataTemplate>
                                    </BindableLayout.ItemTemplate>
                                </FlexLayout>

                                <!-- Time and Status -->
                                <HorizontalStackLayout Spacing="5" HorizontalOptions="End" Margin="0,5,0,0">
                                    <Label Text="{Binding TimeText}"
                                           FontSize="11"
                                           TextColor="Gray" />
                                    <Label Text="{Binding StatusIcon}"
                                           FontSize="11"
                                           TextColor="{Binding StatusIconColor}" />
                                </HorizontalStackLayout>
                            </VerticalStackLayout>
                        </Frame>
                    </Grid>
                </DataTemplate>
            </CollectionView.ItemTemplate>

            <CollectionView.EmptyView>
                <VerticalStackLayout VerticalOptions="Center" HorizontalOptions="Center" Padding="20">
                    <Label Text="ÐÐµÑ‚ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹"
                           FontSize="18"
                           TextColor="Gray"
                           HorizontalOptions="Center" />
                    <Label Text="ÐÐ°Ñ‡Ð½Ð¸Ñ‚Ðµ Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ!"
                           FontSize="14"
                           TextColor="Gray"
                           HorizontalOptions="Center"
                           Margin="0,10,0,0" />
                </VerticalStackLayout>
            </CollectionView.EmptyView>
        </CollectionView>

        <!-- Error/Status Text -->
        <Label x:Name="StatusText"
               Grid.Row="1"
               TextColor="Red"
               IsVisible="False"
               FontSize="14"
               Margin="10,5"
               BackgroundColor="#FFF5F5" />

        <!-- Reply Preview Panel -->
        <Frame x:Name="ReplyPreviewPanel"
               Grid.Row="2"
               IsVisible="False"
               BackgroundColor="#E3F2FD"
               Padding="10"
               Margin="10,0"
               CornerRadius="5"
               HasShadow="False">
            <Grid ColumnDefinitions="Auto,*,Auto">
                <Label Grid.Column="0"
                       Text="â†©"
                       FontSize="18"
                       VerticalOptions="Start"
                       Margin="0,0,10,0"
                       TextColor="#2196F3" />

                <VerticalStackLayout Grid.Column="1" Spacing="2">
                    <Label x:Name="ReplyToSenderLabel"
                           FontSize="12"
                           FontAttributes="Bold"
                           TextColor="#2196F3" />
                    <Label x:Name="ReplyToContentLabel"
                           FontSize="12"
                           TextColor="Gray"
                           LineBreakMode="WordWrap"
                           MaxLines="5" />
                </VerticalStackLayout>

                <Button Grid.Column="2"
                        Text="âœ•"
                        Clicked="OnCancelReplyClicked"
                        BackgroundColor="Transparent"
                        TextColor="Gray"
                        FontSize="18"
                        Padding="5"
                        WidthRequest="30"
                        HeightRequest="30" />
            </Grid>
        </Frame>

        <!-- Emotes Panel Overlay -->
        <Frame x:Name="EmotesPanel"
               Grid.Row="0"
               Grid.RowSpan="4"
               IsVisible="False"
               BackgroundColor="#80000000"
               Padding="0"
               HasShadow="False"
               CornerRadius="0">
            <Frame.GestureRecognizers>
                <TapGestureRecognizer Tapped="OnEmotesPanelBackgroundTapped" />
            </Frame.GestureRecognizers>

            <Frame BackgroundColor="White"
                   Padding="15"
                   CornerRadius="12"
                   HasShadow="True"
                   VerticalOptions="End"
                   Margin="10,10,10,100"
                   MaximumHeightRequest="300">
                <Frame.GestureRecognizers>
                    <TapGestureRecognizer />
                </Frame.GestureRecognizers>

                <Grid RowDefinitions="Auto,*">
                    <Label Grid.Row="0"
                           Text="Ð¡Ð¼Ð°Ð¹Ð»Ñ‹"
                           FontSize="16"
                           FontAttributes="Bold"
                           Margin="0,0,0,10" />

                    <ScrollView Grid.Row="1">
                        <FlexLayout x:Name="EmotesFlexLayout"
                                    Wrap="Wrap"
                                    JustifyContent="Start"
                                    AlignItems="Start" />
                    </ScrollView>
                </Grid>
            </Frame>
        </Frame>

        <!-- Input Area -->
        <Grid Grid.Row="3"
              Padding="10"
              BackgroundColor="#F5F5F5"
              ColumnDefinitions="*,Auto,Auto,Auto">

            <Editor x:Name="MessageInput"
                    Grid.Column="0"
                    Placeholder="Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ..."
                    AutoSize="TextChanges"
                    MaximumHeightRequest="100"
                    VerticalOptions="Center"
                    TextColor="Black"
                    PlaceholderColor="Gray"
                    Margin="0,0,10,0" />

            <Button Grid.Column="1"
                    Text="ðŸ˜Š"
                    Clicked="OnEmotesButtonClicked"
                    BackgroundColor="Transparent"
                    TextColor="Gray"
                    FontSize="20"
                    Padding="10,0" />

            <Button Grid.Column="2"
                    Text="ðŸ“Ž"
                    Clicked="OnAttachFileClicked"
                    BackgroundColor="Transparent"
                    TextColor="Gray"
                    FontSize="20"
                    Padding="10,0" />

            <Button Grid.Column="3"
                    Text="âž¤"
                    Clicked="OnSendClicked"
                    BackgroundColor="#4CAF50"
                    TextColor="White"
                    FontSize="20"
                    WidthRequest="50"
                    HeightRequest="50"
                    CornerRadius="25" />
        </Grid>

    </Grid>

</ContentPage>
