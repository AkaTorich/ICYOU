name: Build iOS

on:
  push:
  pull_request:
  workflow_dispatch:  # Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÑÑ‚Ñƒ ÑÐµÐºÑ†Ð¸ÑŽ
  
jobs:
  build-ios:
    runs-on: macos-latest

    env:
      # ÐžÑ‚ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ¸ Ð´Ð»Ñ CI ÑÐ±Ð¾Ñ€ÐºÐ¸
      _RequireCodeSigning: false
      CodesignKey: ""
      CodesignProvision: ""
      EnableCodeSigning: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            8.0.416
            9.0.x

      - name: Confirm dotnet & Xcode
        run: |
          dotnet --version
          dotnet --list-sdks
          xcodebuild -version || true
          xcrun -sdk iphoneos --show-sdk-version || true
          dotnet workload list || true

      - name: Install MAUI / iOS workloads
        run: |
          dotnet workload install maui --skip-manifest-update
          dotnet workload install ios --skip-manifest-update
          dotnet workload restore

      - name: Restore ICYOU.SDK (iOS)
        run: dotnet restore ICYOU.SDK/ICYOU.SDK.ios.csproj /p:NoWarn=NETSDK1202

      - name: Build ICYOU.SDK (iOS)
        run: dotnet build ICYOU.SDK/ICYOU.SDK.ios.csproj -c Release -f net8.0-ios17.2 -r ios-arm64 /p:NoWarn=NETSDK1202

      - name: Restore ICYOU.Core (iOS)
        run: dotnet restore ICYOU.Core/ICYOU.Core.ios.csproj /p:NoWarn=NETSDK1202

      - name: Build ICYOU.Core (iOS)
        run: dotnet build ICYOU.Core/ICYOU.Core.ios.csproj -c Release -f net8.0-ios17.2 -r ios-arm64 /p:NoWarn=NETSDK1202

      - name: Restore Modules.E2E (iOS)
        run: dotnet restore ICYOU.Modules.E2E/ICYOU.Modules.E2E.ios.csproj /p:NoWarn=NETSDK1202

      - name: Build Modules.E2E (iOS)
        run: dotnet build ICYOU.Modules.E2E/ICYOU.Modules.E2E.ios.csproj -c Release -f net8.0-ios17.2 -r ios-arm64 /p:NoWarn=NETSDK1202

      - name: Restore Modules.Quote (iOS)
        run: dotnet restore ICYOU.Modules.Quote/ICYOU.Modules.Quote.ios.csproj /p:NoWarn=NETSDK1202

      - name: Build Modules.Quote (iOS)
        run: dotnet build ICYOU.Modules.Quote/ICYOU.Modules.Quote.ios.csproj -c Release -f net8.0-ios17.2 -r ios-arm64 /p:NoWarn=NETSDK1202

      - name: Restore Modules.LinkPreview (iOS)
        run: dotnet restore ICYOU.Modules.LinkPreview/ICYOU.Modules.LinkPreview.ios.csproj /p:NoWarn=NETSDK1202

      - name: Build Modules.LinkPreview (iOS)
        run: dotnet build ICYOU.Modules.LinkPreview/ICYOU.Modules.LinkPreview.ios.csproj -c Release -f net8.0-ios17.2 -r ios-arm64 /p:NoWarn=NETSDK1202

      - name: Restore Mobile App (iOS)
        run: dotnet restore ICYOU.Mobile/ICYOU.Mobile.iOS.csproj /p:NoWarn=NETSDK1202

      - name: Publish iOS App (unsigned IPA)
        run: |
          dotnet publish ICYOU.Mobile/ICYOU.Mobile.iOS.csproj \
            -c Release \
            -f net8.0-ios17.2 \
            -r ios-arm64 \
            /p:NoWarn=NETSDK1202 \
            /p:_RequireCodeSigning=false \
            /p:CodesignKey="" \
            /p:CodesignProvision="" \
            /p:EnableCodeSigning=false \
            /p:BuildIpa=true \
            /p:IpaPackageDir="$(Build.ArtifactStagingDirectory)" \
            /p:ArchiveOnBuild=true

      - name: Find and rename IPA
        run: |
          echo "Searching for IPA file..."
          find ICYOU.Mobile/bin/Release/net8.0-ios17.2/ios-arm64/publish -name "*.ipa" -type f

          IPA_FILE=$(find ICYOU.Mobile/bin/Release/net8.0-ios17.2/ios-arm64/publish -name "*.ipa" -type f | head -n 1)

          if [ -n "$IPA_FILE" ]; then
            mkdir -p artifacts
            cp "$IPA_FILE" artifacts/ICYOU-unsigned.ipa
            echo "âœ… IPA file created: artifacts/ICYOU-unsigned.ipa"
            ls -lh artifacts/ICYOU-unsigned.ipa
          else
            echo "âš ï¸ No IPA file found, checking APP bundle..."
            APP_FILE=$(find ICYOU.Mobile/bin/Release/net8.0-ios17.2/ios-arm64/publish -name "*.app" -type d | head -n 1)
            if [ -n "$APP_FILE" ]; then
              echo "Found APP bundle: $APP_FILE"
              mkdir -p Payload
              cp -r "$APP_FILE" Payload/
              cd Payload && zip -r ../artifacts/ICYOU-unsigned.ipa . && cd ..
              rm -rf Payload
              echo "âœ… IPA created from APP bundle: artifacts/ICYOU-unsigned.ipa"
              ls -lh artifacts/ICYOU-unsigned.ipa
            else
              echo "âŒ No IPA or APP found!"
              exit 1
            fi
          fi

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ICYOU-iOS-unsigned
          path: artifacts/ICYOU-unsigned.ipa
          retention-days: 90

      - name: Build Summary
        run: |
          echo "### âœ… iOS Build Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Unsigned IPA file created for AltStore installation**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ **Download:** Go to Actions tab â†’ Artifacts â†’ ICYOU-iOS-unsigned" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“± **Installation methods:**" >> $GITHUB_STEP_SUMMARY
          echo "- **AltStore** (recommended): No Mac needed, auto-refresh every 7 days" >> $GITHUB_STEP_SUMMARY
          echo "- **Sideloadly**: Windows/Mac tool for sideloading" >> $GITHUB_STEP_SUMMARY
          echo "- **Xcode**: Build from source with your Apple ID" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **Note:** Free provisioning certificates expire every 7 days" >> $GITHUB_STEP_SUMMARY
